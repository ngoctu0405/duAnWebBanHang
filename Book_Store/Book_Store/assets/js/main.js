

const SAMPLE = {
  products: [
    {id:1,sku:'B001',name:'Đắc Nhân Tâm',category:'Văn học',price:120000,img:'https://picsum.photos/300/420?random=1',stock:10,desc:'Sách kỹ năng mềm kinh điển.'},
    {id:2,sku:'B002',name:'Tuổi Trẻ Đáng Giá Bao Nhiêu',category:'Tự lực',price:95000,img:'https://picsum.photos/300/420?random=2',stock:8,desc:'Truyền cảm hứng cho tuổi trẻ.'},
    {id:3,sku:'B003',name:'Nhà Giả Kim',category:'Văn học',price:110000,img:'https://picsum.photos/300/420?random=3',stock:5,desc:'Tiểu thuyết phiêu lưu huyền thoại.'},
    {id:4,sku:'B004',name:'Lập Trình JavaScript',category:'IT',price:200000,img:'https://picsum.photos/300/420?random=4',stock:3,desc:'Hướng dẫn JS từ cơ bản đến nâng cao.'},
    { id: 5, sku: 'B005', name: 'Kinh Tế Học Căn Bản', category: 'Kinh tế', price: 150000, img: 'https://picsum.photos/300/420?random=5', stock: 7, desc: 'Những khái niệm kinh tế cơ bản.' },
    { id: 6, sku: 'B006', name: 'Sapiens: Lược Sử Loài Người', category: 'Lịch sử', price: 180000, img: 'https://picsum.photos/300/420?random=6', stock: 4, desc: 'Hành trình phát triển của loài người.' },
    { id: 7, sku: 'B007', name: 'Những Người Khốn Khổ', category: 'Văn học', price: 130000, img: 'https://picsum.photos/300/420?random=7', stock: 6, desc: 'Tác phẩm kinh điển của Victor Hugo.' },
    { id: 8, sku: 'B008', name: 'Giáo Trình Marketing Căn Bản', category: 'Kinh tế', price: 160000, img: 'https://picsum.photos/300/420?random=8', stock: 9, desc: 'Kiến thức marketing từ cơ bản đến nâng cao.' },
    { id: 9, sku: 'B009', name: 'Hành Trình Về Phương Đông', category: 'Tâm linh', price: 140000, img: 'https://picsum.photos/300/420?random=9', stock: 2, desc: 'Khám phá triết lý phương Đông.' },
    { id: 10, sku: 'B010', name: 'Công Nghệ Thông Tin Cơ Bản', category: 'IT', price: 170000, img: 'https://picsum.photos/300/420?random=10', stock: 5, desc: 'Những kiến thức cơ bản về CNTT.' }
  ]
};

if(!localStorage.getItem('bs_data')) localStorage.setItem('bs_data', JSON.stringify(SAMPLE));
if(!localStorage.getItem('bs_cart')) localStorage.setItem('bs_cart', JSON.stringify([]));
function getData(){return JSON.parse(localStorage.getItem('bs_data'))}
function saveData(d){localStorage.setItem('bs_data', JSON.stringify(d))}
function getCart(){return JSON.parse(localStorage.getItem('bs_cart'))}
function saveCart(c){localStorage.setItem('bs_cart', JSON.stringify(c))}
function updateCartCount(){const el = document.querySelector('.nav'); if(!el) return; const count = getCart().reduce((s,i)=>s+i.qty,0); 
  let span=document.getElementById('cart-count'); if(!span){span=document.createElement('span');span.id='cart-count';span.style.marginLeft='6px';el.querySelector('a[href="cart.html"]').appendChild(span);} span.textContent = count;}
function renderFeatured(){const wrap=document.getElementById('featured-list'); if(!wrap) return; const p=getData().products.slice(0,4); wrap.innerHTML = p.map(it=>`<div class="product-card"><img src="${it.img}" alt=""><h3>${it.name}</h3><div class="price">${it.price.toLocaleString('vi-VN')}đ</div><a class="btn" href="product-detail.html?id=${it.id}">Xem</a></div>`).join('')}
function renderProductList(){const wrap=document.getElementById('product-list'); if(!wrap) return; const p=getData().products; wrap.innerHTML = p.map(it=>`<div class="product-card"><img src="${it.img}" alt=""><h3>${it.name}</h3><div class="price">${it.price.toLocaleString('vi-VN')}đ</div><a class="btn" href="product-detail.html?id=${it.id}">Xem</a></div>`).join('')}
function getQueryParam(k){const u=new URLSearchParams(location.search);return u.get(k)}
function renderProductDetail(){const id=getQueryParam('id'); const wrap=document.getElementById('product-detail'); if(!wrap) return; const p=getData().products.find(x=>String(x.id)===String(id))||getData().products[0]; wrap.innerHTML = `<div class='card'><div style='display:flex;gap:20px;flex-wrap:wrap'><img style='width:240px;border-radius:8px' src='${p.img}' alt=''><div><h2>${p.name}</h2><p class='price'>${p.price.toLocaleString('vi-VN')}đ</p><p>${p.desc}</p><label>Số lượng <input id='qty' type='number' value='1' min='1' max='${p.stock}'></label><button class='btn' onclick='addToCart(${p.id})'>Thêm vào giỏ</button></div></div></div>`}
function doSearch(){const q=document.getElementById('q').value.toLowerCase(); const out=document.getElementById('search-results')||document.getElementById('product-list'); const p=getData().products.filter(x=>x.name.toLowerCase().includes(q)); if(out) out.innerHTML = p.map(it=>`<div class="product-card"><img src="${it.img}" alt=""><h3>${it.name}</h3><div class="price">${it.price.toLocaleString('vi-VN')}đ</div><a class="btn" href="product-detail.html?id=${it.id}">Xem</a></div>`).join('')}
function addToCart(id){const cart=getCart(); const qty=Number(document.getElementById('qty')?.value||1); const p=getData().products.find(x=>x.id===id); if(!p) return alert('Không tìm thấy sản phẩm'); const ex=cart.find(i=>i.id===id); if(ex){ex.qty+=qty}else{cart.push({id:id,qty:qty})} saveCart(cart); updateCartCount(); alert('Đã thêm vào giỏ');}
function renderCart(){const wrap=document.getElementById('cart-contents'); if(!wrap) return; const cart=getCart(); if(cart.length===0){wrap.innerHTML='<p>Giỏ hàng rỗng</p>'; return;} const data=getData(); wrap.innerHTML = `<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left">Sản phẩm</th><th>Số lượng</th><th>Giá</th></tr></thead><tbody>${cart.map(i=>{const p=data.products.find(x=>x.id===i.id); return `<tr><td>${p.name}</td><td>${i.qty}</td><td>${(p.price*i.qty).toLocaleString('vi-VN')}đ</td></tr>`}).join('')}</tbody></table><p style="text-align:right;font-weight:700;margin-top:12px">Tổng: ${cart.reduce((s,i)=>{const p=data.products.find(x=>x.id===i.id); return s + p.price*i.qty},0).toLocaleString('vi-VN')}đ</p>`}
function placeOrder(e){e.preventDefault(); const fd=new FormData(e.target); const cart=getCart(); if(cart.length===0) return alert('Giỏ hàng rỗng'); const data=getData(); const total=cart.reduce((s,i)=>{const p=data.products.find(x=>x.id===i.id); return s + p.price*i.qty},0); const order={id:Date.now(),code:'ORD'+Date.now(),fullname:fd.get('fullname'),address:fd.get('address'),phone:fd.get('phone'),items:cart,total:total,status:'new',created_at:new Date().toISOString()}; if(!localStorage.getItem('bs_orders')) localStorage.setItem('bs_orders', JSON.stringify([])); const orders=JSON.parse(localStorage.getItem('bs_orders')); orders.push(order); localStorage.setItem('bs_orders', JSON.stringify(orders)); saveCart([]); alert('Đặt hàng thành công. Mã: '+order.code); window.location.href='orders.html'}
function renderMyOrders(){const wrap=document.getElementById('my-orders'); if(!wrap) return; const orders=JSON.parse(localStorage.getItem('bs_orders')||'[]'); if(orders.length===0){wrap.innerHTML='<p>Không có đơn hàng</p>'; return;} wrap.innerHTML = orders.map(o=>`<div class='card'><h4>${o.code}</h4><p>Tổng: ${o.total.toLocaleString('vi-VN')}đ</p><p>Trạng thái: ${o.status}</p><p><a href='order-detail.html?id=${o.id}'>Xem</a></p></div>`).join('')}
function renderOrderDetail(){const id=new URLSearchParams(location.search).get('id'); const wrap=document.getElementById('order-detail'); if(!wrap) return; const orders=JSON.parse(localStorage.getItem('bs_orders')||'[]'); const o=orders.find(x=>String(x.id)===String(id)); if(!o) return wrap.innerHTML='<p>Không tìm thấy đơn</p>'; wrap.innerHTML = `<div class='card'><h3>${o.code}</h3><p>Họ tên: ${o.fullname}</p><p>Địa chỉ: ${o.address}</p><p>Tổng: ${o.total.toLocaleString('vi-VN')}đ</p><pre>${JSON.stringify(o.items,null,2)}</pre></div>`}
function loginUser(e){e.preventDefault(); const fd=new FormData(e.target); const email=fd.get('email'); const pass=fd.get('password');
  if(email==='admin@example.com' && pass==='admin'){localStorage.setItem('bs_role','admin'); window.location.href='admin/dashboard.html'; return}
  if(email==='user@example.com' && pass==='123'){localStorage.setItem('bs_role','user'); localStorage.setItem('bs_user', JSON.stringify({email})); window.location.href='index.html'; return}
  alert('Sai email hoặc mật khẩu (demo: admin@example.com/admin ; user@example.com/123)')}
function registerUser(e){e.preventDefault(); const fd=new FormData(e.target); const name=fd.get('name'); const email=fd.get('email'); const pass=fd.get('password');
  let users=JSON.parse(localStorage.getItem('bs_users')||'[]'); if(users.find(u=>u.email===email)) return alert('Email đã tồn tại'); users.push({name,email,pass}); localStorage.setItem('bs_users', JSON.stringify(users)); localStorage.setItem('bs_user', JSON.stringify({email,name})); alert('Đăng ký thành công'); window.location.href='index.html'}
function adminLogin(e){e.preventDefault(); const fd=new FormData(e.target); if(fd.get('user')==='admin' && fd.get('pass')==='admin'){localStorage.setItem('bs_role','admin'); window.location.href='admin/dashboard.html'} else alert('Sai')}

document.addEventListener('DOMContentLoaded', function(){renderFeatured(); renderProductList(); renderCart(); updateCartCount(); renderProductDetail(); renderMyOrders(); renderOrderDetail();})
